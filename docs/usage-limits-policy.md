# 利用制限の考え方（表向きは無制限）

## 方針

- **表向き**: 「無制限」として訴求する（プラン説明・アプリ内の表記）。
- **実態**: バックエンドで**ソフトな上限**を設け、極端な利用や不正利用で採算が崩れないようにする。
- 通常のユーザーにはほぼ触れない水準にし、**上限に達したユーザーには「しばらく時間をおいてください」など穏やかなメッセージ**で対応する（「無制限ではない」とは言わない）。

---

## 制限の置き方（案）

| 種類 | 方針（確定） | 目的 |
|------|--------------|------|
| **月あたりメッセージ数** | **2,000/月**（`MONTHLY_MESSAGE_LIMIT=2000`） | 想定を超えるヘビーユーザーで採算が崩れないようにする。全員使い切っても利益出る。宣伝は「実質無制限」。 |
| **1日あたり** | **なし** | 本当に使う人に「今日はもう送れない」と出るのを避ける。月限だけでボットも 2,000 で止まる。 |
| **同時リクエスト** | 例: 1リクエスト処理中は次の送信を待つ | サーバー負荷とAPIの連打を防ぐ。 |

※ 数値はサービス開始後にログを見て調整してよい。

---

## 上限に達するユーザーはどれくらいか（目安）

- **想定している「ふつうの利用」**: 月 100〜500 メッセージ程度。多くのユーザーはこのあたり。
- **上限の目安**: 月 2,000〜3,000 なので、**「ふつう」の 4〜30 倍**の利用でようやく届く。
- 一般的なサービスでは、**もっとも利用する数％のユーザー**が全体の利用の多くを占めることが多い。月 2,000 以上を送る人は、**全体の数％以下**と考えるのが自然。
- **結論**: 上限に達する恐れがあるのは**ごく一部**（おおよそ数％）と想定され、**「結構いる」という水準ではない**。運用でログを見て、必要なら上限値だけ調整すればよい。

---

## 全ユーザーが上限を使い倒した場合の利益（1980円プラン）

**取り分**: Apple 15% 控除後 **1,683円/人・月**

| 上限（メッセージ/月） | モデル組み合わせ | APIコスト/人 | 粗利/人 | 利益 |
|----------------------|------------------|--------------|---------|------|
| 2,000 | GPT-4o mini + Gemini 2.0 Flash（0.15円/通） | 300円 | 1,383円 | **出る** |
| 3,000 | 同上 | 450円 | 1,233円 | **出る** |
| 2,000 | GPT-4o mini + Gemini 3 Flash（0.47円/通） | 940円 | 743円 | **出る** |
| 3,000 | 同上 | 1,410円 | 273円 | **出る（薄い）** |

**結論**: 上限を **月2,000** または **月3,000** にしておけば、**全員が上限まで使っても利益は出る**。Gemini 3 Flash で 3,000 まで使うとマージンはかなり薄くなるので、その組み合わせなら上限は **2,000 前後**にしておくか、2.0 Flash にするかで調整すると安心。

---

## ユーザーへの見せ方

- アプリ・ランディングでは **「無制限」** のまま。
- 上限に達した場合のメッセージ例:  
  「本日はたくさんご利用いただきありがとうございます。しばらく時間をおいてからまたお試しください。」  
  → 「〇〇回の制限です」とは出さない。

---

## 実装時のメモ

- 会員IDごとに「今月のメッセージ数」「本日のメッセージ数」をDBまたはキャッシュでカウント。
- 送信前にチェックし、超えていれば上記の穏やかなメッセージを返す。APIは呼ばない。
- 制限値は**環境変数**（例: `MONTHLY_MESSAGE_LIMIT`, `DAILY_MESSAGE_LIMIT`）で持つと、後から変更しやすい。
