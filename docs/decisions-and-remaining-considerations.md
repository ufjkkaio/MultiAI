# 確定した方針と、残りの検討事項

## 確定した方針

| 項目 | 内容 |
|------|------|
| **価格** | 1,980円/月 |
| **モデル（固定）** | GPT-4o mini + Gemini 3 Flash |
| **プラットフォーム** | まずは iOS のみ（それでよい） |

---

## 会員・サブスクは「Apple 任せ」でいいか

**支払いと認証の「窓口」は Apple 任せでよい。ただし「誰が有料会員か」を把握する部分は自分側に少し必要。**

### Apple に任せられること

| 項目 | 内容 |
|------|------|
| **認証（誰か）** | Sign in with Apple で「この人はこの Apple ID」と識別。ログイン画面・認証フローは Apple。 |
| **課金・継続・解約** | App Store のサブスク。請求・更新・解約はすべて Apple。 |

### 自分側で必要なこと（薄いバックエンド）

| 項目 | 内容 |
|------|------|
| **会員の紐づけ** | Sign in with Apple で得た「ユーザー識別子」を、あなたのDBの「会員」と1対1で紐づける。 |
| **サブスク状態の把握** | 「この会員はいま有料期間か？」を判定する必要がある。方法はどちらか：**App Store Server Notifications** で Apple から「課金開始・更新・解約」を受け取り、DB に保存する **or** アプリからレシートを送り、サーバーが Apple に問い合わせて検証する。 |
| **アクセス制御** | チャットやAPIを叩く前に「この会員は有料か？」を上記の情報で確認し、有料なら処理、無料なら「購入を促す」など。 |

**まとめ**: 会員登録の「画面」と課金の「処理」は Apple 任せでよい。**「誰が会員か」「誰が有料か」を記録・判定するのは自分側のサーバー**で行う。そのための薄いバックエンド（会員テーブル・サブスク状態・チャットAPI）は必要。

---

## iOS のみで最初はよいか

**はい、それでよい。** まずは iOS のみでリリースし、会員・サブスクは Sign in with Apple + App Store サブスクに寄せる形で問題ない。

---

## 考える部分の順番（すべて決めてから実装）

実装前に、次の順で決める。

| # | 項目 | 決めること |
|---|------|------------|
| **1** | **バックエンドのホスティング** | サーバーをどこに置くか。実装の土台になる。 |
| 2 | 一つのAPIが落ちたときの挙動 | 片方だけ返す / リトライ / エラー表示。 |
| 3 | 利用上限の具体的な数値 | 月〇〇通・日〇〇通。環境変数名も決める。 |
| 4 | Gemini 3 Flash の正式モデルID | API で指定する文字列を確認。 |
| 5 | プライバシーポリシー・利用規約 | 文言と掲載URL。審査で必要。 |
| 6 | App Store Connect の設定 | サブスク商品・Small Business・審査用資料。 |

---

## 1. バックエンドのホスティング（まずここ）

チャットAPI・会員DB・履歴・サブスク状態を動かす**サーバーをどこに置くか**。ここが決まらないと実装を始められない。

### 候補のイメージ

| 候補 | 特徴 | 向いている人 |
|------|------|----------------|
| **Vercel** | Next.js が得意。サーバーレス。DB は別（Supabase 等）と組み合わせが多い。 | フロントも Next でやりたい／既に使ったことがある。 |
| **Railway** | 小規模バックエンドに使いやすい。DB も同じところで用意できる。 | シンプルに1箇所でまとめたい。 |
| **AWS（Lambda + RDS 等）** | 柔軟でスケールしやすい。設定は多め。 | すでに AWS 経験がある。 |
| **Cloud Run（GCP）** | コンテナで動かす。Gemini と同じ Google なので連携しやすい。 | GCP を使いたい。 |

### 決めること

- **ランタイム**: Node.js で API を書くか、Python か。（iOS アプリは別で、Swift。）
- **DB**: 会員・ルーム・メッセージ・サブスク状態をどこに保存するか（Supabase / Railway の DB / Firebase など）。
- **環境変数**: API キーやモデル名を本番でどこに登録するか（各サービスの「環境変数」画面で設定）。

### おすすめ：Railway

**「全くわからない」場合は Railway を推す。**

| 理由 | 説明 |
|------|------|
| **1箇所で完結** | バックエンド（API）と DB（PostgreSQL）を同じダッシュボードで用意できる。Vercel だと DB は別サービス（Supabase 等）が必要。 |
| **設定が少ない** | プロジェクト作成 → DB 追加 → 環境変数を入力 → デプロイ、の流れが分かりやすい。 |
| **無料枠で試せる** | 月額の無料クレジットがあり、小規模ならまずお金をかけずに試せる。 |
| **日本語情報** | 利用者が多く、検索すれば手順が出てきやすい。 |

**ランタイム**: Node.js で API を書く（こちらで実装する想定）。  
**DB**: Railway の「PostgreSQL」を同じプロジェクトで追加する。

別案として「Next.js を触りたい」なら Vercel + Supabase でもよいが、**まずは Railway 1本で進める**のが分かりやすい。

**決定**: **Railway** で進める。バックエンド（Node.js API）と DB（PostgreSQL）を Railway で用意する。

---

## 2. 一つのAPIが落ちたときの挙動（次に決める）

片方（OpenAI または Gemini）だけエラーになったとき、どうするか。

| 案 | 内容 | メリット | デメリット |
|----|------|----------|------------|
| **A** | **片方だけ返答を返す** | ユーザーは少なくとも1体の返答を見られる。 | 片方だけ表示になる。 |
| B | 両方失敗としてエラーメッセージ | 挙動が単純。 | ユーザーは返答を一切見られない。 |
| C | 失敗した方だけリトライ（1回など） | 一時的な不調で回復することがある。 | 実装がやや複雑。待ち時間が伸びる。 |

**決定**: **A（片方だけ返答を返す）**。片方のAPIだけエラーなら、成功した方の返答だけ返す。両方エラーならエラーメッセージを表示する。

---

## 3. 利用上限の具体的な数値（次に決める）

表向き無制限・裏でソフト制限。

**1日200通について**: 雑談や相談で「かなり使う日」なら届く水準。本当に使う人に「今日はもう送れない」と出るのを避けたいなら、日限は設けない方がよい。

**確定**: **1日の上限はなし、月 2,000 通のみ**。

| 種類 | 数値 | 環境変数名 |
|------|------|------------|
| **月あたり** | **2,000 通/月** | `MONTHLY_MESSAGE_LIMIT=2000` |
| **1日あたり** | **なし** | （変数なし） |

※ 月 2,000 で全員使い切っても利益は出る試算済み。宣伝は「実質無制限」で問題なし。

---

## 4. Gemini 3 Flash の正式モデルID（確認済み）

**「モデルID」とは**: API を呼ぶときに「どのモデルを使うか」を指定する**文字列**。間違えるとリクエストが失敗する。

**Gemini 3 Flash**（Google 公式 API 利用時）:
- プレビュー版: **`gemini-3-flash-preview`**
- 実装時は [Google AI の公式ドキュメント](https://ai.google.dev/gemini-api/docs) で最新のモデル名を再確認すること。本番用の `gemini-3-flash` などが追加されている場合がある。

**OpenAI**（GPT-4o mini）: **`gpt-4o-mini`** で問題なし（変更されていなければそのまま使用）。

---

## 5. プライバシーポリシー・利用規約（ドラフト作成済み）

App Store 審査で「プライバシーポリシーURL」「利用規約URL」を求められることが多いため、ドラフトを用意した。

- **プライバシーポリシー**: `docs/legal/privacy-policy-draft.md`
- **利用規約**: `docs/legal/terms-of-use-draft.md`

**同意画面のUI（確定）**  
- 疑問文は使わない。  
- **上段**: 利用規約へのリンク、プライバシーポリシーへのリンクを表示する。  
- **下段**: 「利用規約とプライバシーポリシーに同意する」の文言と**チェックボックス**を表示する。  
- チェックを入れた場合のみ次へ進める（例：同意ボタンを有効にする）。

**あなたがすること（審査前に）**  
1. [サービス名] を実際のアプリ名に置き換える。  
2. [連絡先メールアドレス] [運営者所在地] [日付] を記入する。  
3. 上記2本を、ウェブページや Notion などに掲載し、**URL を取得する**。  
4. App Store Connect の審査項目で、その URL を入力する。

---

## 6. App Store Connect の設定（審査提出前に実施）

- サブスク商品（1,980円/月）の作成  
- Small Business Program の申請  
- 審査用スクリーンショット・説明文  
- 上記 5 のプライバシーポリシー・利用規約の URL の登録

---

## 一言まとめ

- **価格 1,980円・モデル 4o-mini + 3 Flash・iOS のみ** で進めてよい。
- **会員・サブスクの「窓口」は Apple 任せ**でよいが、**「誰が有料か」を記録・判定する薄いバックエンド**は必要。
- 上記の「他に考えること」をリスト化したので、実装前〜審査前に順に詰めるとよい。
