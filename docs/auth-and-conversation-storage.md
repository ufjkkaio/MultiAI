# 会員登録の方法と、会話の記憶

## 1. 会員登録はどうするか

iOSアプリで「誰か」を識別し、サブスク状態・会話履歴と紐づける必要がある。

### 候補

| 方法 | 内容 | メリット | デメリット |
|------|------|----------|------------|
| **Sign in with Apple** | Apple IDでログイン | 審査で有利になりやすい。プライバシー志向。実装が標準で用意されている。 | Apple IDを持っていないユーザーは別手段が必要。 |
| **メール＋パスワード** | 自前でアカウント作成 | どの端末・OSでも同じアカウントで使える。 | パスワード管理・リセット・セキュリティを自前で用意する必要がある。 |
| **Google ログイン** | Googleアカウントでログイン | 利用者が多い。 | iOSで他社ログインを入れる場合、**Sign in with Apple も並べて提供する必要**がある（App Store のガイドライン）。 |

### おすすめの進め方

- **まずは Sign in with Apple のみ**  
  - 会員登録＝「Apple IDでログイン」にする。  
  - 実装がシンプルで、App Store のガイドラインにも合いやすい。  
- **バックエンド**でやること  
  - ログイン時に Apple から渡される **ユーザー識別子（subject / user ID）** を受け取り、  
  - そのユーザー用の「会員レコード」「サブスク状態」「会話履歴」を紐づけて保存する。

### 流れのイメージ

1. アプリ起動 → 未ログインなら「Sign in with Apple」を表示。
2. ユーザーがタップ → Apple が認証 → アプリが **識別子（と必要ならメール等）** を取得。
3. アプリがバックエンドに「この識別子でログイン」と送る。
4. バックエンドは「既存会員ならそのまま、新規なら会員レコード作成」し、トークンやセッションを返す。
5. 以降、その会員IDでサブスク状態の確認・会話の保存・取得を行う。

---

## 2. 会話をアプリ（サーバー）で記憶する

**はい。会話内容をサーバー側で記憶した方が、無駄な会話は減り、トークンも節約できます。**

### 記憶する理由

| 目的 | 説明 |
|------|------|
| **無駄な会話を省く** | 毎回「私は〇〇について相談しています」とやり直さなくてよい。前のやりとりを前提に会話できる。 |
| **トークン節約** | 必要な分だけ履歴をAPIに送る（直近N件や要約）。全文を毎回送らなければコストが抑えられる。 |
| **体験のよさ** | アプリを開き直しても過去のルーム・メッセージが残る。続きから話せる。 |

### どこに記憶するか

- **サーバー（バックエンド）に保存する**のが現実的。  
  - 会員ID・ルームID・メッセージ（誰が・いつ・何を言ったか）をDBに保存。  
  - アプリは「このルームの履歴をください」とサーバーに要求し、表示する。  
- アプリ単体のローカルだけだと、端末を替えると履歴が消えるし、サブスク状態と履歴の紐づけもできない。

### APIに渡すコンテキスト

- ユーザーがメッセージを送るたびに、**「このルームの直近の会話」**（例：直近20件や、直近4,000トークン分など）を各AIのAPIに渡す。  
- 必要なら「それより前は要約して1ブロック」にしてもよい。  
- そうすることで「同じことを何度も説明する」無駄が減り、会話が自然になる。

### まとめ

- **会員登録**：まずは **Sign in with Apple** で「会員」を識別し、バックエンドで会員・サブスク・履歴を紐づける。  
- **会話の記憶**：**サーバーに会話を保存**し、返信時にその履歴の一部をコンテキストとしてAPIに渡す。無駄な会話を省き、トークンも節約できる。
